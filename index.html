<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Pro - GitHub Pages</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"></script>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light Theme Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-accent: #495057;
            --border-color: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            
            /* Chat Colors */
            --user-bubble: #007bff;
            --user-text: #ffffff;
            --ai-bubble: #f8f9fa;
            --ai-text: #212529;
            --ai-border: #e9ecef;
            
            /* Status Colors */
            --online-color: #28a745;
            --offline-color: #dc3545;
            --warning-color: #ffc107;
            
            /* Animation */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        [data-theme="dark"] {
            /* Dark Theme Colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-accent: #d0d0d0;
            --border-color: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.4);
            
            /* Chat Colors for Dark Theme */
            --user-bubble: #0066cc;
            --user-text: #ffffff;
            --ai-bubble: #2d2d2d;
            --ai-text: #ffffff;
            --ai-border: #404040;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* Main Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: 0 0 20px var(--shadow);
        }

        /* Header Styles */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            background: linear-gradient(135deg, #007bff, #0056b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online-color);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--offline-color);
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            border-color: var(--user-bubble);
            color: var(--user-bubble);
            transform: scale(1.1);
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: var(--bg-primary);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Welcome Message */
        .welcome-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px;
        }

        .welcome-content {
            text-align: center;
            color: var(--text-secondary);
            max-width: 400px;
        }

        .welcome-content i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--user-bubble);
            opacity: 0.7;
        }

        .welcome-content h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .welcome-content p {
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Message Bubbles */
        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: slideIn 0.3s var(--bounce);
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow);
            transition: var(--transition);
        }

        .message-bubble:hover {
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateY(-1px);
        }

        .message.user .message-bubble {
            background: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 6px;
        }

        .message.ai .message-bubble {
            background: var(--ai-bubble);
            color: var(--ai-text);
            border: 1px solid var(--ai-border);
            border-bottom-left-radius: 6px;
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Loading Indicator */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .typing-animation {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Input Area */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            padding: 0.5rem 1rem;
            transition: var(--transition);
        }

        .input-container:focus-within {
            border-color: var(--user-bubble);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: none;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            font-family: inherit;
            min-height: 24px;
            max-height: 120px;
        }

        #messageInput::placeholder {
            color: var(--text-secondary);
        }

        .send-button {
            background: var(--user-bubble);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .char-counter, .memory-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Error Toast */
        .error-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc3545;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 8px 32px rgba(220, 53, 69, 0.3);
            animation: slideUp 0.3s var(--bounce);
            z-index: 1000;
            max-width: 90%;
        }

        .close-toast {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .close-toast:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
            }
            
            .chat-header {
                padding: 0.75rem 1rem;
            }
            
            .header-content h1 {
                font-size: 1.25rem;
            }
            
            .chat-messages {
                padding: 0.75rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .input-area {
                padding: 0.75rem;
            }
            
            .input-container {
                padding: 0.4rem 0.75rem;
            }
            
            .error-toast {
                bottom: 80px;
                left: 1rem;
                right: 1rem;
                transform: none;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .status-indicator {
                font-size: 0.75rem;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 0.6rem 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <header class="chat-header">
            <div class="header-content">
                <h1>AI Chat Pro</h1>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Online</span>
                </div>
            </div>
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                <i data-feather="sun" id="themeIcon"></i>
            </button>
        </header>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="welcome-content">
                    <i data-feather="message-circle"></i>
                    <h3>Welcome to AI Chat Pro</h3>
                    <p>Start a conversation with our AI assistant powered by Gemini 2.0 Flash</p>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <div class="typing-animation">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span>AI is thinking...</span>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    placeholder="Type your message... (Shift+Enter for new line, Enter to send)"
                    rows="1"
                    maxlength="2000"
                ></textarea>
                <button id="sendButton" class="send-button" title="Send Message">
                    <i data-feather="send"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="char-counter" id="charCounter">0/2000</span>
                <span class="memory-info" id="memoryInfo">Memory: 0/10000</span>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="error-toast" id="errorToast" style="display: none;">
        <i data-feather="alert-triangle"></i>
        <span id="errorMessage"></span>
        <button class="close-toast" id="closeToast">
            <i data-feather="x"></i>
        </button>
    </div>

    <script>
// AI Chat Pro - GitHub Pages Version
// This file contains the core functionality for the chat application

class ChatApp {
    constructor() {
        // Configuration - untuk GitHub Pages
        this.API_KEY = 'AIzaSyBSZUCrHWZcopKuyp9bZ6vIc-XqiTFYyBQ'; // API key hardcoded untuk GitHub Pages
        this.API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        this.MAX_MESSAGES = 10000;
        this.STORAGE_KEY = 'ai_chat_messages';
        this.THEME_KEY = 'ai_chat_theme';
        
        // System prompt - dapat dimodifikasi oleh developer di sini
        this.SYSTEM_PROMPT = `Kamu adalah AI pintar yang menjawab dengan gaya santai, ramah, dan jelas. 
        Berikan respons yang helpful, akurat, dan mudah dipahami. 
        Jika diminta menjelaskan sesuatu yang kompleks, gunakan contoh atau analogi yang relatable.
        Selalu maintain tone yang positif dan supportive.`;
        
        // App state
        this.messages = [];
        this.isLoading = false;
        this.isOnline = navigator.onLine;
        
        // Initialize app
        this.initializeElements();
        this.loadMessages();
        this.loadTheme();
        this.setupEventListeners();
        this.updateUI();
        this.autoResize();
        
        console.log('AI Chat Pro initialized successfully');
    }
    
    // Initialize DOM elements
    initializeElements() {
        this.elements = {
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            themeToggle: document.getElementById('themeToggle'),
            themeIcon: document.getElementById('themeIcon'),
            charCounter: document.getElementById('charCounter'),
            memoryInfo: document.getElementById('memoryInfo'),
            errorToast: document.getElementById('errorToast'),
            errorMessage: document.getElementById('errorMessage'),
            closeToast: document.getElementById('closeToast')
        };
    }
    
    // Setup all event listeners
    setupEventListeners() {
        // Send message events
        this.elements.sendButton.addEventListener('click', () => this.sendMessage());
        this.elements.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.elements.messageInput.addEventListener('input', () => this.handleInputChange());
        
        // Theme toggle
        this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
        
        // Online/offline status
        window.addEventListener('online', () => this.updateOnlineStatus(true));
        window.addEventListener('offline', () => this.updateOnlineStatus(false));
        
        // Error toast close
        this.elements.closeToast.addEventListener('click', () => this.hideErrorToast());
        
        // Auto-hide error toast after 5 seconds
        let errorToastTimeout;
        const showErrorToast = this.showErrorToast.bind(this);
        this.showErrorToast = (message) => {
            showErrorToast(message);
            clearTimeout(errorToastTimeout);
            errorToastTimeout = setTimeout(() => this.hideErrorToast(), 5000);
        };
    }
    
    // Handle keyboard input
    handleKeyDown(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter: add new line (default behavior)
                return;
            } else {
                // Enter: send message
                e.preventDefault();
                this.sendMessage();
            }
        }
    }
    
    // Handle input changes (character counter, auto-resize)
    handleInputChange() {
        const input = this.elements.messageInput;
        const length = input.value.length;
        
        // Update character counter
        this.elements.charCounter.textContent = `${length}/2000`;
        
        // Auto-resize textarea
        this.autoResize();
        
        // Update send button state
        this.elements.sendButton.disabled = length === 0 || this.isLoading;
    }
    
    // Auto-resize textarea based on content
    autoResize() {
        const input = this.elements.messageInput;
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }
    
    // Send message to AI
    async sendMessage() {
        const input = this.elements.messageInput;
        const message = input.value.trim();
        
        if (!message || this.isLoading) return;
        
        // Check online status
        if (!this.isOnline) {
            this.showErrorToast('No internet connection. Please check your network and try again.');
            return;
        }
        
        // Add user message
        this.addMessage(message, 'user');
        input.value = '';
        this.handleInputChange();
        
        // Show loading state
        this.setLoading(true);
        
        try {
            // Prepare conversation context
            const conversationHistory = this.prepareConversationHistory();
            
            // Make API call
            const response = await this.callGeminiAPI(conversationHistory, message);
            
            // Add AI response
            this.addMessage(response, 'ai');
            
        } catch (error) {
            console.error('Error sending message:', error);
            this.showErrorToast('Failed to get AI response. Please try again.');
            
            // Remove user message if API call failed
            if (this.messages.length > 0 && this.messages[this.messages.length - 1].type === 'user') {
                this.messages.pop();
                this.saveMessages();
                this.renderMessages();
            }
        } finally {
            this.setLoading(false);
        }
    }
    
    // Prepare conversation history for API call
    prepareConversationHistory() {
        // Get recent messages for context (limit to last 20 exchanges to manage token usage)
        const recentMessages = this.messages.slice(-40);
        
        const contents = [];
        
        // Add system instruction
        contents.push({
            role: 'user',
            parts: [{ text: this.SYSTEM_PROMPT }]
        });
        
        contents.push({
            role: 'model',
            parts: [{ text: 'Understood. I will respond in a friendly, casual, and clear manner as requested.' }]
        });
        
        // Add conversation history
        recentMessages.forEach(msg => {
            if (msg.type === 'user') {
                contents.push({
                    role: 'user',
                    parts: [{ text: msg.content }]
                });
            } else if (msg.type === 'ai') {
                contents.push({
                    role: 'model',
                    parts: [{ text: msg.content }]
                });
            }
        });
        
        return contents;
    }
    
    // Call Gemini API directly (untuk GitHub Pages)
    async callGeminiAPI(conversationHistory, newMessage) {
        const requestBody = {
            contents: [
                ...conversationHistory,
                {
                    role: 'user',
                    parts: [{ text: newMessage }]
                }
            ],
            generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 2048,
            },
            safetySettings: [
                {
                    category: 'HARM_CATEGORY_HARASSMENT',
                    threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                },
                {
                    category: 'HARM_CATEGORY_HATE_SPEECH',
                    threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                },
                {
                    category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
                    threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                },
                {
                    category: 'HARM_CATEGORY_DANGEROUS_CONTENT',
                    threshold: 'BLOCK_MEDIUM_AND_ABOVE'
                }
            ]
        };
        
        const response = await fetch(`${this.API_URL}?key=${this.API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        
        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('Invalid response format from API');
        }
        
        return data.candidates[0].content.parts[0].text;
    }
    
    // Add message to conversation
    addMessage(content, type) {
        const message = {
            id: Date.now() + Math.random(),
            content,
            type,
            timestamp: new Date().toISOString()
        };
        
        this.messages.push(message);
        
        // Manage memory limit
        if (this.messages.length > this.MAX_MESSAGES) {
            this.messages = this.messages.slice(-this.MAX_MESSAGES);
        }
        
        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();
        
        // Auto-scroll to bottom
        setTimeout(() => this.scrollToBottom(), 100);
    }
    
    // Render all messages
    renderMessages() {
        const container = this.elements.chatMessages;
        
        if (this.messages.length === 0) {
            // Show welcome message if no messages
            container.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-content">
                        <i data-feather="message-circle"></i>
                        <h3>Welcome to AI Chat Pro</h3>
                        <p>Start a conversation with our AI assistant powered by Gemini 2.0 Flash</p>
                    </div>
                </div>
            `;
            feather.replace();
            return;
        }
        
        container.innerHTML = '';
        
        this.messages.forEach(message => {
            const messageEl = this.createMessageElement(message);
            container.appendChild(messageEl);
        });
        
        feather.replace();
    }
    
    // Create individual message element
    createMessageElement(message) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.type}`;
        messageEl.innerHTML = `
            <div class="message-bubble">
                ${this.formatMessageContent(message.content)}
                <small class="message-time">${this.formatTime(message.timestamp)}</small>
            </div>
        `;
        return messageEl;
    }
    
    // Format message content (handle line breaks, etc.)
    formatMessageContent(content) {
        return content
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    // Format timestamp for display
    formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false
        });
    }
    
    // Scroll chat to bottom
    scrollToBottom() {
        const container = this.elements.chatMessages;
        container.scrollTop = container.scrollHeight;
    }
    
    // Set loading state
    setLoading(loading) {
        this.isLoading = loading;
        this.elements.loadingIndicator.style.display = loading ? 'flex' : 'none';
        this.elements.sendButton.disabled = loading || this.elements.messageInput.value.trim() === '';
        this.elements.messageInput.disabled = loading;
        
        if (loading) {
            this.scrollToBottom();
        }
    }
    
    // Update online/offline status
    updateOnlineStatus(online) {
        this.isOnline = online;
        this.elements.statusDot.className = `status-dot ${online ? '' : 'offline'}`;
        this.elements.statusText.textContent = online ? 'Online' : 'Offline';
        
        if (!online) {
            this.showErrorToast('Connection lost. Please check your internet connection.');
        }
    }
    
    // Theme management
    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem(this.THEME_KEY, newTheme);
        
        // Update theme icon
        const iconName = newTheme === 'dark' ? 'moon' : 'sun';
        this.elements.themeIcon.setAttribute('data-feather', iconName);
        feather.replace();
    }
    
    // Load saved theme
    loadTheme() {
        const savedTheme = localStorage.getItem(this.THEME_KEY) || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Update theme icon
        const iconName = savedTheme === 'dark' ? 'moon' : 'sun';
        this.elements.themeIcon.setAttribute('data-feather', iconName);
    }
    
    // Save messages to localStorage
    saveMessages() {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.messages));
        } catch (error) {
            console.error('Failed to save messages:', error);
            this.showErrorToast('Failed to save conversation. Storage may be full.');
        }
    }
    
    // Load messages from localStorage
    loadMessages() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                this.messages = JSON.parse(saved);
                
                // Validate and clean up loaded messages
                this.messages = this.messages.filter(msg => 
                    msg && msg.content && msg.type && msg.timestamp
                );
                
                // Ensure memory limit
                if (this.messages.length > this.MAX_MESSAGES) {
                    this.messages = this.messages.slice(-this.MAX_MESSAGES);
                    this.saveMessages();
                }
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
            this.messages = [];
        }
    }
    
    // Update memory info display
    updateMemoryInfo() {
        this.elements.memoryInfo.textContent = `Memory: ${this.messages.length}/${this.MAX_MESSAGES}`;
    }
    
    // Update UI components
    updateUI() {
        this.renderMessages();
        this.updateMemoryInfo();
        this.updateOnlineStatus(this.isOnline);
        this.handleInputChange();
    }
    
    // Show error toast
    showErrorToast(message) {
        this.elements.errorMessage.textContent = message;
        this.elements.errorToast.style.display = 'flex';
        feather.replace();
    }
    
    // Hide error toast
    hideErrorToast() {
        this.elements.errorToast.style.display = 'none';
    }
    
    // Clear all messages (for future use)
    clearMessages() {
        this.messages = [];
        this.saveMessages();
        this.renderMessages();
        this.updateMemoryInfo();
    }
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.chatApp = new ChatApp();
    
    // Initialize feather icons
    feather.replace();
});
    </script>
</body>
</html>